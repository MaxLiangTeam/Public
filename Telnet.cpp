/*---------------------------------------------------------------------------
Œƒº˛    : 
√Ë ˆ    : 
◊˜’ﬂ    : wsl
∞Ê±æ    : V1.0
 ±º‰    : 2012-01-13
2012-01-13 ∏ƒ∞Ê
2012-02-27 ‘Ÿ¥Œ–ﬁ∏ƒ
2012-09-26 –ﬁ∏ƒ≈–∂œΩ· ¯∑˚∫Ø ˝
---------------------------------------------------------------------------*/

#include "StdAfx.h"
#include "Telnet.h"
#include "Kernel.h"

struct check_end_tab 
{
	int (CTelnet::*p)(CString& strCmd,CString& strPack,CString& strData);// ∫Ø ˝÷∏’Î
} check_end[] = {
	&CTelnet::CheckEnd0,//LST≤È—Ø÷∏¡Ó
	&CTelnet::CheckEnd1,//µ˜’˚÷∏¡Ó
	&CTelnet::CheckEnd2,//DSP
	&CTelnet::CheckEnd3,//µ«¬ºªÿ∏¥
	&CTelnet::CheckEnd4,//
	&CTelnet::CheckEnd5,//MMLµ«¬Ω◊¢≤·Õ¯‘™
	&CTelnet::CheckEnd6,//MML◊¢œ˙Õ¯‘™
	&CTelnet::CheckEnd7,//µ«≥ˆªÿ∏¥
	&CTelnet::CheckEnd8//ºÏ≤‚23∂Àø⁄
};
bool CTelnet::m_bInit = false;

CTelnet::CTelnet(void)
:m_nTimeout(30)
{
	m_hSocket = INVALID_SOCKET;
	if (!m_bInit)
	{
		m_bInit = true;
		WSADATA wsaData = {0};
		WORD wVersionRequested = MAKEWORD( 2, 2 );
		WSAStartup( wVersionRequested, &wsaData);
	}

	m_bBuf.SetSize(1024);
}

CTelnet::~CTelnet(void)
{
	m_bExit = true;
	if (m_hSocket != INVALID_SOCKET)
	{
		closesocket(m_hSocket);
	}
	m_hSocket = INVALID_SOCKET;
}

//ºÏ≤È «∑Ò «Ω” ’ÕÍ’˚ ˝æ›∞¸±Í÷æ
int CTelnet::CheckEnd0(CString& strCmd,CString& strPack,CString& strData)
{
	if (strData.Find("∏¸–¬") != -1)
	{
		return 0;//Ω” ’Ω· ¯±Í÷æ
	}
	return -1;
}

//µ˜’˚÷∏¡ÓΩ· ¯ºÏ≤‚
int CTelnet::CheckEnd1(CString& strCmd,CString& strPack,CString& strData)
{
	CString strFlag,strDataInfo;
	strDataInfo = BufferFilter(strData.GetBuffer(0));
	if (strCmd.Find("KILL MUTEXRIGHT")!= -1)
	{
		strFlag = " Õ∑≈ª•≥‚»®œﬁ≥…π¶";
	}
	else if (strCmd.Find("APPLY MUTEXRIGHT")!= -1)
	{
		strFlag = "…Í«Îª•≥‚»®œﬁ≥…π¶";
	}
	else if (strCmd.Find("RELEASE MUTEXRIGHT")!= -1)
	{
		strFlag = " Õ∑≈ª•≥‚»®œﬁ≥…π¶";
	}
	else if (strCmd.Find("UPDATE:MOC=")!= -1)
	{
		strFlag = "∂‘œÛ±ª∏¸–¬";
	}
	else if (strCmd.Find("SYNC:POS")!= -1)
	{
		strFlag = "»´≤ø≥…π¶";
	}
	if(strDataInfo.Find("Ω·π˚") != -1)
	{
		int nPos = strDataInfo.Find("Ω·π˚");
		strDataInfo.Delete(0,nPos);
		CString strRight = strDataInfo.Right(2);
		if (strDataInfo.Find(strFlag) != -1 && strRight.Find("$>") != -1)
		{
			return 0;//Ω” ’Ω· ¯±Í÷æ
		}
		else if (strDataInfo.Find("≤ø∑÷≥…π¶") != -1 && strRight.Find("$>") != -1 && strCmd.Find("SYNC:POS")!= -1)
		{
			return 0;
		}
		else if (strDataInfo.Find("√¸¡Ó÷¥–– ß∞‹") != -1 && strRight.Find("$>") != -1 && strCmd.Find("SYNC:POS")!= -1)
		{
			return -2;
		}
	}

	return -1;
}

//DSP÷∏¡ÓΩ· ¯ºÏ≤‚
int CTelnet::CheckEnd2(CString& strCmd,CString& strPack,CString& strData)
{
	if((strPack.Find("π≤”–") != -1 || strPack.Find("(Ω·π˚∏ˆ ˝") != -1) && strPack.Find("END") != -1)
	{
		if (strData.Find(strCmd) != -1)
		{
			return 0;//Ω” ’Ω· ¯±Í÷æ
		}
	}
	return -1;
}

//µ«¬ºΩ· ¯ºÏ≤‚
int CTelnet::CheckEnd3(CString& strCmd,CString& strPack,CString& strData)
{
	if(strPack.Find("END") != -1 && strCmd.Find("LGI:OP") != -1 && strData.Find("%%LGI:OP") != -1)
	{
		return 0;
	}
	return -1;
}

//EXPORTΩ· ¯∑˚≈–∂œ
int CTelnet::CheckEnd4(CString& strCmd,CString& strPack,CString& strData)
{
	CString strEnd = strPack.Right(1024);
	if(strEnd.Find("◊¥Ã¨  =  ≥…π¶") != -1 || strEnd.Find("Œƒº˛“—±ª¥Ê¥¢µΩ") != -1)
	{
		if (strData.Find("%%EXP CFGMML") != -1)
		{
			return 0;
		}
	}
	return -1;
}

//MML◊¢≤·Õ¯‘™
int CTelnet::CheckEnd5(CString& strCmd,CString& strPack,CString& strData)
{
	if(strPack.Find("%%REG NE:NAME") != -1 && strData.Find("END") != -1)
	{
		return 0;//Ω” ’Ω· ¯±Í÷æ
	}
	return -1;
}

//MML◊¢œ˙Õ¯‘™
int CTelnet::CheckEnd6(CString& strCmd,CString& strPack,CString& strData)
{
	if(strPack.Find("%%UNREG NE:NAME") != -1 && strData.Find("END") != -1)
	{
		return 0;//Ω” ’Ω· ¯±Í÷æ
	}
	return -1;
}

//µ«≥ˆ
int CTelnet::CheckEnd7(CString& strCmd,CString& strPack,CString& strData)
{
	if(strPack.Find("%%LGO:OP") != -1  && strData.Find("END") != -1)
	{
		return 0;//Ω” ’Ω· ¯±Í÷æ
	}
	return -1;
}

int CTelnet::CheckEnd8(CString& strCmd,CString& strPack,CString& strData)
{
	if(strPack.Find(">") != -1 || strPack.Find("<") != -1)
	{
		return 0;//Ω” ’Ω· ¯±Í÷æ
	}
	return -1;
}

bool CTelnet::CheckLoginMsg(CString& strCmd)
{
	CString strPWDFlag = "PWD=\"";
	CString strEMSFlag = "\",DN=EMS";
	CString strNoEMSFlag = "\";";
	CString strCmdTemp = strCmd;

	int nPWDpos = strCmdTemp.Find(strPWDFlag);
	if (nPWDpos == std::string::npos)
	{
		return false;
	}

	int nEMSpos = strCmdTemp.Find(strEMSFlag,nPWDpos);
	int nNoEMSpos = strCmdTemp.Find(strNoEMSFlag,nPWDpos);

	if(nEMSpos != std::string::npos)
	{
		//…æ≥˝pwd»ª∫Û”√*ÃÊªª
		strCmdTemp.Delete(nPWDpos + strPWDFlag.GetLength(),nEMSpos - (nPWDpos + strPWDFlag.GetLength()));
		strCmdTemp.Insert(nPWDpos + strPWDFlag.GetLength(),"******");
	}
	else if(nNoEMSpos != std::string::npos)
	{
		//…æ≥˝pwd»ª∫Û”√*ÃÊªª
		strCmdTemp.Delete(nPWDpos + strPWDFlag.GetLength(),nNoEMSpos - (nPWDpos + strPWDFlag.GetLength()));
		strCmdTemp.Insert(nPWDpos + strPWDFlag.GetLength(),"******");
	}
	else
	{
		return false;
	}

	if(strCmdTemp.IsEmpty()) return false;

	strCmd = strCmdTemp;
	return true;
}

int CTelnet::Send(CString strCmd,CString& strData,enCheckEnd enCheck,bool bIsSend)
{
	CString strLog;
	if (!bIsSend)
	{
		strLog.Format("[%s][CTelnet::Send] ≤ª∑¢ÀÕ÷∏¡Ó=[%s]\n",m_strThreadName,strCmd);
		CheckLoginMsg(strLog);
		g_pLog->WriteLog(strLog,m_strLogFile,LOG_INFO);

		strData = "RETCODE = 0";
		return strData.GetLength();
	}

	//»Áπ˚Œ™windows,∑¢ÀÕ÷∏¡Ó–Ë“™º”ªÿ≥µ
	//if(g_bIsTest)g_pConfig->m_nEnter = 0;
	CString newCmd = strCmd + (g_pConfig->m_nEnter ? "\r\n" : "");
	int nLen = send(m_hSocket,newCmd.GetBuffer(),newCmd.GetLength(),0);

	if (nLen <= 0)
	{
		strLog.Format("[%s][CTelnet::Send] ÷∏¡Ó=[%s] ∑¢ÀÕ ß∞‹",m_strThreadName,strCmd);
		CheckLoginMsg(strLog);
		g_pLog->WriteLog(strLog,m_strLogFile,LOG_ERROR);
		return -1;//∑¢ÀÕ ß∞‹
	}
	strLog.Format("[%s][CTelnet::Send] ∑¢ÀÕ÷∏¡Ó=[%s]\n",m_strThreadName,strCmd);
	CheckLoginMsg(strLog);
	g_pLog->WriteLog(strLog,m_strLogFile,LOG_INFO);
	
	//«Âø’Ω” ’ ˝æ›
	strData.Empty();

	//…Ë÷√Ω” ’≥¨ ± ±º‰
	int nTimeout(m_nTimeout);
	if (enCheck != CHECK_EXEC)
	{
		nTimeout = 5;
	}
	//»Áπ˚ «SET GTRXADMSTAT: Timeout ±º‰…ËŒ™1∑÷÷”
	if (newCmd.Find("SYNC:POS=") != -1)
	{
		nTimeout = 600;
	}

	time_t t = time(NULL);
	while (!m_bExit)
	{
		//ø™ ºΩ” ’
		char szBuff[1024+1] = {0};//1k
		int nRecvLen = recv(m_hSocket,szBuff,1024,0);
		if (nRecvLen < 0)
		{
			if (strData.IsEmpty())
			{
				if (time(NULL) - t >= nTimeout)
				{
					strLog.Format("[%s][CTelnet::Send] ÷∏¡Ó=[%s] Ω” ’Œ™ø’,≥¨ ± ±º‰=%d s",m_strThreadName,strCmd,time(NULL) - t);
					g_pLog->WriteLog(strLog,m_strLogFile,LOG_ERROR);
					return -2;
				}
				continue;
			}
			else
			{
				if (time(NULL) - t < nTimeout)continue;

				if (0 != (this->*check_end[enCheck].p)(strCmd,strData,strData))
				{
					strLog.Format("[%s][CTelnet::Send] ÷∏¡Ó=[%s] Ω” ’≤ªÕÍ’˚,≥¨ ± ±º‰=%d s\n%s",m_strThreadName,strCmd,nTimeout,strData);
					g_pLog->WriteLog(strLog,m_strLogFile,LOG_ERROR);
					return -2;//-2 Œ™Ω” ’ ß∞‹
				}
				break;//Ω” ’ÕÍ’˚
			}
		}
		CString strRecv(BufferFilter(&szBuff[0]));
		//BufferFilter(strRecv.GetString(0));
		strRecv.Replace("\r","");
		strData += strRecv;
		
		//≈–∂œ «∑ÒΩ” ‹ÕÍ±œ
		int nRetCmd = (this->*check_end[enCheck].p)(strCmd,strRecv,strData);
		if (-1 != nRetCmd)
		{
			if (-2 == nRetCmd)
			{
				return -3;
			}
			break;//Ω” ’ÕÍ±œ
		}

		//add by maxliang 20130904 ºÏ≤È «∑Ò≥¨ ±
		if (time(NULL) - t >= nTimeout)
		{
			strLog.Format("[%s][CTelnet::Send] ÷∏¡Ó=[%s] Ω” ’≥¨ ±,≥¨ ± ±º‰=%d s\n%s",m_strThreadName,strCmd,nTimeout,strData);
			g_pLog->WriteLog(strLog,m_strLogFile,LOG_ERROR);
			return -2; 
		}
		Sleep(1);
	}
	CString strDataInfo = BufferFilter(strData.GetBuffer(0));
	strLog.Format("[%s][CTelnet::Recv] [%s]",m_strThreadName,strDataInfo);
	g_pLog->WriteLog(strLog,m_strLogFile,LOG_INFO);
	return strDataInfo.GetLength();
}

int CTelnet::Send(CString strCmd,CString& strData,bool bIsSend)
{
	CString strLog;
	if (!bIsSend)
	{
		strLog.Format("[%s][CTelnet::Send] ≤ª∑¢ÀÕ÷∏¡Ó=[%s]\n",m_strThreadName,strCmd);
		CheckLoginMsg(strLog);
		g_pLog->WriteLog(strLog,m_strLogFile,LOG_INFO);

		strData = "RETCODE = 0";
		return strData.GetLength();
	}

	//»Áπ˚Œ™windows,∑¢ÀÕ÷∏¡Ó–Ë“™º”ªÿ≥µ
	//if(g_bIsTest)g_pConfig->m_nEnter = 0;
	CString newCmd = strCmd + (g_pConfig->m_nEnter ? "\r\n" : "");
	int nLen = send(m_hSocket,newCmd.GetBuffer(),newCmd.GetLength(),0);

	if (nLen <= 0)
	{
		strLog.Format("[%s][CTelnet::Send] ÷∏¡Ó=[%s] ∑¢ÀÕ ß∞‹",m_strThreadName,strCmd);
		CheckLoginMsg(strLog);
		g_pLog->WriteLog(strLog,m_strLogFile,LOG_ERROR);
		return -1;//∑¢ÀÕ ß∞‹
	}
	strLog.Format("[%s][CTelnet::Send] ∑¢ÀÕ÷∏¡Ó=[%s]\n",m_strThreadName,strCmd);
	CheckLoginMsg(strLog);
	g_pLog->WriteLog(strLog,m_strLogFile,LOG_INFO);

	//«Âø’Ω” ’ ˝æ›
	strData.Empty();
	//…Ë÷√Ω” ’≥¨ ± ±º‰
	int nTimeout(m_nTimeout);
	if (newCmd.Find("SYNC:POS=") != -1)
	{
		nTimeout = 600;
	}

	time_t t = time(NULL);
	char szBuff[1024+1];//1k
	bool bReMark(false);
	CString strTemp;
	int nRecvLen = recv(m_hSocket,szBuff,1024,0);
	while (nRecvLen > 0)
	{
		CString strRecv = szBuff;
		//strRecv.Replace("\n","");
		//strTemp += strRecv;
		//g_pLog->WriteLog(strRecv,m_strLogFile,LOG_INFO);
		if(strRecv.Find("Ω·π˚") != -1 )
		{
			//strRecv.Replace("[D[D","");
			int nPos = strRecv.Find("Ω·π˚");
			strRecv.Delete(0,nPos);
			bReMark = true;
		}
		if (bReMark)
		{
			strData += strRecv;
		}
		
		int nLen = strData.GetLength();
		// µ±Ω” ’µΩƒ©Œ≤Œ™ $> ±Ì æΩ· ¯
		CString strRight = strData.Right(2);
		//Ω” ‹ÕÍ±œ,≥§∂»–°”⁄1024≤ªŒ™ø’,«“‘⁄◊Ó∫Û√Ê’“µΩ◊÷∑˚¥Æ\n>,æÕ¥˙±ÌΩ” ’ÕÍ±œ
		if (strRight.Find("$>") != -1 && strData.Find("Ω·π˚") != -1  /*&& strData.Find(strCmd) != -1*/)
		{
			bool bRet(false);
			if (strCmd.Find("SYNC:POS") != -1)
			{
				//  ∑¢ÀÕÕ¨≤Ω÷∏¡Ó, µ»¥˝Ω” ’“Ï≤Ω∑µªÿ–≈œ¢
				strLog.Format("[%s][Telnet::Send] ∑¢ÀÕÕ¨≤Ω÷∏¡Ó, µ»¥˝Ω” ’“Ï≤Ω–ﬁ∏ƒΩ¯∂»–≈œ¢.",m_strThreadName);
				g_pLog->WriteLog(strLog,m_strLogFile,LOG_INFO);
				while(nRecvLen > 0)
				{
					if (strData.Find("√¸¡Ó÷¥–– ß∞‹") != -1)
					{
						return -3;
					}
					//strData += BufferReplace(strRecv);
					//g_pLog->WriteLog(strData,m_strLogFile,LOG_INFO);
					if (strData.Find("»´≤ø≥…π¶") != -1)
					{
						bRet = true;
						break;
					}

					//// µ±Ω” ’µΩƒ©Œ≤Œ™ " ˝æ›Õ¨≤Ω  (◊‹ ˝:1 ≥…π¶:1  ß∞‹:0)»´≤ø≥…π¶[100]" ±Ì æΩ· ¯
					//int nPos = 0;
					//nPos = strData.Find(" ˝æ›Õ¨≤Ω", nPos);
					//if (nPos != -1)
					//{
					//	nPos = strData.Find("◊‹ ˝", nPos);
					//	if (nPos != -1)
					//	{
					//		nPos = strData.Find("≥…π¶", nPos);
					//		if (nPos != -1)
					//		{
					//			nPos = strData.Find(" ß∞‹", nPos);
					//			if (nPos != -1)
					//			{
					//				int nLeft = 0;
					//				nLeft = strData.Find(":", nPos);
					//				int nRight = 0;
					//				nRight = strData.Find(")", nLeft);
					//				CString strRet = strData.Mid(nLeft+1, nRight-nLeft-1);								
					//				if (strRet != "0")
					//				{
					//					return -2;
					//				}
					//				bRet = true;
					//				break;
					//			}							
					//		}
					//	}
					//}

					Sleep(10);
					memset(szBuff, '\0', sizeof(szBuff));
					nRecvLen = recv(m_hSocket, szBuff, sizeof(szBuff), 0);
					CString strRecv = szBuff;
					strData += BufferReplace(strRecv);
					//strData += BufferFilter(strRecv.GetBuffer(0));

					if (time(NULL) - t >= nTimeout)
					{
						strLog.Format("[%s][CTelnet::Send] ÷∏¡Ó=[%s] Ω” ’≥¨ ±,≥¨ ± ±º‰=%d s\n%s",m_strThreadName,strCmd,nTimeout,strData);
						g_pLog->WriteLog(strLog,m_strLogFile,LOG_ERROR);
						return -2; 
					}
				}
			}
			else if((strData.Find("≥…π¶") != -1 ||strData.Find("∏¸–¬") != -1))
			{
				bRet = true;
			}
			else
			{
				//ºÃ–¯Ω” ’÷±µΩ≥¨ ±
				Sleep(10);
				memset(szBuff,'\0',1024+1);
				nRecvLen = recv(m_hSocket,szBuff,1024,0);

				if (time(NULL) - t >= nTimeout)
				{
					strLog.Format("[%s][CTelnet::Send] ÷∏¡Ó=[%s] Ω” ’≥¨ ±,≥¨ ± ±º‰=%d s\n%s",m_strThreadName,strCmd,m_nTimeout,strData);
					g_pLog->WriteLog(strLog,m_strLogFile,LOG_ERROR);
					return -2; 
				}

				continue;
			}

			if(bRet)
			{
				strLog.Format("[%s][CTelnet::Send][%s] ÷¥––≥…π¶",m_strThreadName,strData);
				g_pLog->WriteLog(strLog,m_strLogFile,LOG_INFO);
				return strData.GetLength();
			}
			else
			{
				strLog.Format("[%s][CTelnet::Send][%s] ÷¥–– ß∞‹",m_strThreadName,strData);
				g_pLog->WriteLog(strLog,m_strLogFile,LOG_ERROR);
				return -2;
			}
		}

		Sleep(10);
		memset(szBuff,'\0',1024+1);
		nRecvLen = recv(m_hSocket,szBuff,1024,0);

		if (time(NULL) - t >= nTimeout)
		{
			strLog.Format("[%s][CTelnet::Send] ÷∏¡Ó=[%s] Ω” ’≥¨ ±,≥¨ ± ±º‰=%d s\n%s",m_strThreadName,strCmd,m_nTimeout,strData);
			g_pLog->WriteLog(strLog,m_strLogFile,LOG_ERROR);
			return -2; 
		}
	}
	if (nRecvLen == -1)
	{
		strLog.Format("[%s][CTelnet::Send] ÷∏¡Ó=[%s] Ω” ’Œ™ø’",m_strThreadName,strCmd);
		g_pLog->WriteLog(strLog,m_strLogFile,LOG_ERROR);
		return -2;
	}
	g_pLog->WriteLog(strData,m_strLogFile,LOG_INFO);
	return strData.GetLength();
}

int CTelnet::SendCMD(CString strCmd,CString& strData,bool bIsSend)
{
	CString strLog;
	if (!bIsSend)
	{
		strLog.Format("[%s][CTelnet::Send] ≤ª∑¢ÀÕ÷∏¡Ó=[%s]\n",m_strThreadName,strCmd);
		CheckLoginMsg(strLog);
		g_pLog->WriteLog(strLog,m_strLogFile,LOG_INFO);

		strData = "RETCODE = 0";
		return strData.GetLength();
	}

	//»Áπ˚Œ™windows,∑¢ÀÕ÷∏¡Ó–Ë“™º”ªÿ≥µ
	//if(g_bIsTest)g_pConfig->m_nEnter = 0;
	CString newCmd = strCmd + (g_pConfig->m_nEnter ? "\r\n" : "");
	int nLen = send(m_hSocket,newCmd.GetBuffer(),newCmd.GetLength(),0);

	if (nLen <= 0)
	{
		strLog.Format("[%s][CTelnet::Send] ÷∏¡Ó=[%s] ∑¢ÀÕ ß∞‹",m_strThreadName,strCmd);
		CheckLoginMsg(strLog);
		g_pLog->WriteLog(strLog,m_strLogFile,LOG_ERROR);
		return -1;//∑¢ÀÕ ß∞‹
	}
	strLog.Format("[%s][CTelnet::Send] ∑¢ÀÕ÷∏¡Ó=[%s]\n",m_strThreadName,strCmd);
	CheckLoginMsg(strLog);
	g_pLog->WriteLog(strLog,m_strLogFile,LOG_INFO);

	//«Âø’Ω” ’ ˝æ›
	strData.Empty();
	//…Ë÷√Ω” ’≥¨ ± ±º‰
	int nTimeout(m_nTimeout);
	if (newCmd.Find("SYNC:POS=") != -1)
	{
		nTimeout = 600;
	}

	time_t t = time(NULL);
	char szBuff[1024+1];//1k
	bool bReMark(false);
	CString strTemp;
	int nRecvLen = recv(m_hSocket,szBuff,1024,0);
	while (nRecvLen > 0)
	{
		CString strRecv = szBuff;
		strData += BufferFilter(strRecv.GetBuffer(0));

		if (strData.Right(2) == "$>")
		{
			bool bRet(false);
			//strData.Replace("\r\n","");
			CString strCheck(strData);
			strCheck.Remove('\n');

/*			if (strCmd.Find("RELEASE MUTEXRIGHT") != -1)
			{
				if (strData.Find(" Õ∑≈ª•≥‚»®œﬁ≥…π¶") != -1)
				{
					bRet = true;
					break;
				}

				Sleep(500);
				memset(szBuff, '\0', sizeof(szBuff));
				nRecvLen = recv(m_hSocket, szBuff, sizeof(szBuff), 0);
				CString strRecv = szBuff;
				strData += BufferFilter(strRecv.GetBuffer(0));

				if (time(NULL) - t >= nTimeout)
				{
					strLog.Format("[%s][CTelnet::Send] ÷∏¡Ó=[%s] Ω” ’≥¨ ±,≥¨ ± ±º‰=%d s\n%s",m_strThreadName,strCmd,m_nTimeout,strData);
					g_pLog->WriteLog(strLog,m_strLogFile,LOG_ERROR);
					return -2; 
				}
			}
			else */if (strCmd.Find("SYNC:POS") != -1)
			{
				//  ∑¢ÀÕÕ¨≤Ω÷∏¡Ó, µ»¥˝Ω” ’“Ï≤Ω∑µªÿ–≈œ¢
				strLog.Format("[%s][Telnet::Send] ∑¢ÀÕÕ¨≤Ω÷∏¡Ó, µ»¥˝Ω” ’“Ï≤Ω–ﬁ∏ƒΩ¯∂»–≈œ¢.",m_strThreadName);
				g_pLog->WriteLog(strLog,m_strLogFile,LOG_INFO);
				while(nRecvLen > 0)
				{
					if (strData.Find("√¸¡Ó÷¥–– ß∞‹") != -1)
					{
						return -3;
					}
					// µ±Ω” ’µΩƒ©Œ≤Œ™ " ˝æ›Õ¨≤Ω  (◊‹ ˝:1 ≥…π¶:1  ß∞‹:0)»´≤ø≥…π¶[100]" ±Ì æΩ· ¯
					int nPos = 0;
					nPos = strData.Find(" ˝æ›Õ¨≤Ω", nPos);
					if (nPos != -1)
					{
						nPos = strData.Find("◊‹ ˝", nPos);
						if (nPos != -1)
						{
							nPos = strData.Find("≥…π¶", nPos);
							if (nPos != -1)
							{
								nPos = strData.Find(" ß∞‹", nPos);
								if (nPos != -1)
								{
									int nLeft = 0;
									nLeft = strData.Find(":", nPos);
									int nRight = 0;
									nRight = strData.Find(")", nLeft);
									CString strRet = strData.Mid(nLeft+1, nRight-nLeft-1);								
									if (strRet != "0")
									{
										return -2;
									}
									bRet = true;
									break;
								}							
							}
						}
					}

					Sleep(500);
					memset(szBuff, '\0', sizeof(szBuff));
					nRecvLen = recv(m_hSocket, szBuff, sizeof(szBuff), 0);
					CString strRecv = szBuff;
					strData += BufferFilter(strRecv.GetBuffer(0));

					if (time(NULL) - t >= nTimeout)
					{
						strLog.Format("[%s][CTelnet::Send] ÷∏¡Ó=[%s] Ω” ’≥¨ ±,≥¨ ± ±º‰=%d s\n%s",m_strThreadName,strCmd,m_nTimeout,strData);
						g_pLog->WriteLog(strLog,m_strLogFile,LOG_ERROR);
						return -2; 
					}
				}
			}
			else if(strCheck.Find(strCmd) != -1 && (strData.Find("≥…π¶") != -1 ||strData.Find("∏¸–¬") != -1))
			{
				bRet = true;
			}
			else
			{
				//ºÃ–¯Ω” ’÷±µΩ≥¨ ±
				Sleep(10);
				memset(szBuff,'\0',1024+1);
				nRecvLen = recv(m_hSocket,szBuff,1024,0);

				if (time(NULL) - t >= nTimeout)
				{
					strLog.Format("[%s][CTelnet::Send] ÷∏¡Ó=[%s] Ω” ’≥¨ ±,≥¨ ± ±º‰=%d s\n%s",m_strThreadName,strCmd,m_nTimeout,strData);
					g_pLog->WriteLog(strLog,m_strLogFile,LOG_ERROR);
					return -2; 
				}

				continue;
			}

			if(bRet)
			{
				strLog.Format("[%s][CTelnet::Send][%s] ÷¥––≥…π¶",m_strThreadName,strData);
				g_pLog->WriteLog(strLog,m_strLogFile,LOG_INFO);
				return strData.GetLength();
			}
			else
			{
				strLog.Format("[%s][CTelnet::Send][%s] ÷¥–– ß∞‹",m_strThreadName,strData);
				g_pLog->WriteLog(strLog,m_strLogFile,LOG_ERROR);
				return -2;
			}
		}
		
		Sleep(10);
		memset(szBuff,'\0',1024+1);
		nRecvLen = recv(m_hSocket,szBuff,1024,0);

		if (time(NULL) - t >= nTimeout)
		{
			strLog.Format("[%s][CTelnet::Send] ÷∏¡Ó=[%s] Ω” ’≥¨ ±,≥¨ ± ±º‰=%d s\n%s",m_strThreadName,strCmd,m_nTimeout,strData);
			g_pLog->WriteLog(strLog,m_strLogFile,LOG_ERROR);
			return -2; 
		}
	}
	if (nRecvLen == -1)
	{
		strLog.Format("[%s][CTelnet::Send] ÷∏¡Ó=[%s] Ω” ’Œ™ø’",m_strThreadName,strCmd);
		g_pLog->WriteLog(strLog,m_strLogFile,LOG_ERROR);
		return -2;
	}
	g_pLog->WriteLog(strData,m_strLogFile,LOG_INFO);
	return strData.GetLength();
}

bool CTelnet::Login(CString strIP,int nPort,CString strUser,CString strPassword,int nLoginType)
{
	CString strLog;
	//¥¥Ω®socket
	m_hSocket = socket(AF_INET,SOCK_STREAM,IPPROTO_IP);

	if (m_hSocket == INVALID_SOCKET)
	{
		strLog = "[CTelnet::Login] socket(AF_INET,SOCK_STREAM,IPPROTO_IP) Error!\n";
		g_pLog->WriteLog(strLog,m_strLogFile,LOG_ERROR);
		return false;
	}

	//ππ‘Ïµÿ÷∑∫Õ∂Àø⁄
	sockaddr_in addr;
	addr.sin_family = AF_INET;
	addr.sin_port = htons(nPort);
	addr.sin_addr.s_addr = inet_addr(strIP);

	//¡¨Ω”µΩ∑˛ŒÒ∆˜
	int nResult = connect(m_hSocket,(sockaddr*)&addr,sizeof(sockaddr));	
	if(nResult == SOCKET_ERROR)
	{
		closesocket(m_hSocket);
		m_hSocket = INVALID_SOCKET;
		CString strLog;
		strLog.Format("[%s][CTelnet::Login] Connect [%s:%d] Error\n",m_strThreadName,strIP,nPort);
		g_pLog->WriteLog(strLog,m_strLogFile,LOG_ERROR);
		return false;
	}

	m_bExit = false;
	int nNetTimeout =  30*1000;//30√Î£¨
	//…Ë÷√Ω” ’≥¨ ±
	setsockopt(m_hSocket,SOL_SOCKET,SO_RCVTIMEO,(char *)&nNetTimeout,sizeof(int));

	return SendLoginInfo(strUser, strPassword);

}


bool CTelnet::MMLLogin(CString strIP,int nPort, CString strName,
					   CString strUser,CString strPassword,int nLoginType)
{
	CString strLog;
	//¥¥Ω®socket
	m_hSocket = socket(AF_INET,SOCK_STREAM,IPPROTO_IP);

	if (m_hSocket == INVALID_SOCKET)
	{
		strLog = "[CTelnet::MMLLogin] socket(AF_INET,SOCK_STREAM,IPPROTO_IP) Error!\n";
		g_pLog->WriteLog(strLog,m_strLogFile,LOG_ERROR);
		return false;
	}

	//ππ‘Ïµÿ÷∑∫Õ∂Àø⁄
	sockaddr_in addr;
	addr.sin_family = AF_INET;
	addr.sin_port = htons(nPort);
	addr.sin_addr.s_addr = inet_addr(strIP);

	//¡¨Ω”µΩ∑˛ŒÒ∆˜
	int nResult = connect(m_hSocket,(sockaddr*)&addr,sizeof(sockaddr));	
	if(nResult == SOCKET_ERROR)
	{
		closesocket(m_hSocket);
		m_hSocket = INVALID_SOCKET;
		CString strLog;
		strLog.Format("[%s][CTelnet::MMLLogin] Connect [%s:%d] Error\n",m_strThreadName,strIP,nPort);
		g_pLog->WriteLog(strLog,m_strLogFile,LOG_ERROR);
		return false;
	}

	m_bExit = false;
	int nNetTimeout =  30*1000;//30√Î£¨
	//…Ë÷√Ω” ’≥¨ ±
	setsockopt(m_hSocket,SOL_SOCKET,SO_RCVTIMEO,(char *)&nNetTimeout,sizeof(int));

	//ππ‘Ïµ«¬º◊÷∑˚¥Æ
	CString strLogin;
	strLogin.Format("LGI:OP=\"%s\",PWD=\"%s\",DN=EMS;",strUser,strPassword);

	CString strRecv("");
	bool bRes(false);
	int nRet = Send(strLogin,strRecv,CHECK_LOGIN);
	if (-1 != strRecv.Find("RETCODE = 0") && -1 != strRecv.Find("LGI:OP"))
	{
		strLog.Format("[%s][CTelnet::MMLLogin] µ«¬ºM2000≥…π¶\n",m_strThreadName);
		g_pLog->WriteLog(strLog,m_strLogFile,LOG_INFO);
		bRes = true;
	}

	if(!bRes)
	{
		//µ«¬º ß∞‹£¨‘Úπÿ±’SOCKET
		closesocket(m_hSocket);
		m_hSocket = INVALID_SOCKET;
		strLog.Format("[%s][CTelnet::MMLLogin] µ«¬ºM2000 ß∞‹-->[%s:%d]\n%s\n",m_strThreadName,strIP,nPort,strLogin);
		g_pLog->WriteLog(strLog,m_strLogFile,LOG_ERROR);
		return false;
	}

	//◊¢≤·Õ¯‘™
	CString strRegNe;
	strRegNe.Format("REG NE:NAME=\"%s\";",strName);
	strRecv = "";
	nRet = Send(strRegNe,strRecv,CHECK_MMLREG);
	if (-1 != strRecv.Find("RETCODE = 0"))
	{
		strLog.Format("[%s][CTelnet::MMLLogin] ◊¢≤·Õ¯‘™≥…π¶\n",m_strThreadName);
		g_pLog->WriteLog(strLog,m_strLogFile,LOG_INFO);
		return true;//◊¢≤·Õ¯‘™≥…π¶
	}

	//µ«¬º ß∞‹£¨‘Úπÿ±’SOCKET
	closesocket(m_hSocket);
	m_hSocket = INVALID_SOCKET;
	strLog.Format("[%s][CTelnet::MMLLogin] ◊¢≤·Õ¯‘™ ß∞‹-->[%s:%d]\n%s\n",m_strThreadName,strIP,nPort,strLogin);
	g_pLog->WriteLog(strLog,m_strLogFile,LOG_ERROR);
	return false;
}

// π”√23∂Àø⁄Ω¯––telnetµ«¬Ω
bool CTelnet::Login(CString& strIP,const CString& strUser,const CString& strPassword)
{
	CString strLog;
	//¥¥Ω®socket
	m_hSocket = socket(AF_INET,SOCK_STREAM,IPPROTO_IP);

	if (m_hSocket == INVALID_SOCKET)
	{
		strLog = "[CTelnet::Login] socket(AF_INET,SOCK_STREAM,IPPROTO_IP) Error!\n";
		g_pLog->WriteLog(strLog,m_strLogFile,LOG_ERROR);
		return false;
	}

	//ππ‘Ïµÿ÷∑∫Õ∂Àø⁄
	sockaddr_in addr;
	addr.sin_family = AF_INET;
	addr.sin_port = htons(23);
	addr.sin_addr.s_addr = inet_addr(strIP);

	//¡¨Ω”µΩ∑˛ŒÒ∆˜
	int nResult = connect(m_hSocket,(sockaddr*)&addr,sizeof(sockaddr));	
	if(nResult == SOCKET_ERROR)
	{
		closesocket(m_hSocket);
		m_hSocket = INVALID_SOCKET;
		CString strLog;
		strLog.Format("[%s][CTelnet::Login] Connect [%s:%d] Error\n",m_strThreadName,strIP,23);
		g_pLog->WriteLog(strLog,m_strLogFile,LOG_ERROR);
		return false;
	}

	m_bExit = false;
	int nNetTimeout =  30*1000;//30√Î£¨
	//…Ë÷√Ω” ’≥¨ ±
	setsockopt(m_hSocket,SOL_SOCKET,SO_RCVTIMEO,(char *)&nNetTimeout,sizeof(int));

	return SendLoginInfo(strUser, strPassword);
}

bool CTelnet::SendMsg(const CString& strMsg)
{
    CString strLog;
	CString newCmd = strMsg + (g_pConfig->m_nEnter ? "\r\n" : "");

	int nLen = send(m_hSocket,newCmd.GetBuffer(0),newCmd.GetLength(),0);
	if (nLen <= 0)
	{
		strLog.Format("[%s][CTelnet::SendLoginInfo] œ˚œ¢=[%s] ∑¢ÀÕ ß∞‹",m_strThreadName,newCmd);
		g_pLog->WriteLog(strLog,m_strLogFile,LOG_ERROR);
		return false;//∑¢ÀÕ ß∞‹
	}
	strLog.Format("[%s][CTelnet::SendLoginInfo] œ˚œ¢=[%s] ∑¢ÀÕ",m_strThreadName,newCmd);
	g_pLog->WriteLog(strLog,m_strLogFile,LOG_INFO);
	return true;
}

bool CTelnet::SendLoginInfo(const CString& strUser,const CString& strPassword)
{
	bool bRet = false;
	bool bLoginSuccess = false;

	int nRecvTimes(0);
	DWORD d1 = GetTickCount();
	while(nRecvTimes < 100)
	{
		nRecvTimes++;

		//-------------------------Ω” ’ªÿ∏¥,∞—∑µªÿµƒ–≈œ¢¥Ê∑≈µΩm_strNormalText÷–-------------------MSG_WAITALL

		char szBuf[1024] = {0};
		int nBytes = recv(m_hSocket, szBuf, sizeof(szBuf),0);


		if ( nBytes <= 0 )
		{
			DWORD d2 = GetTickCount();
			if (d2 - d1 > 110*1000)      //‘ –Ì110√Îµƒ¡¨Ω” ±º‰
			{
				return false;
			}
			if (WSAETIMEDOUT != WSAGetLastError())//”…”⁄¡¨Ω”∑Ω‘⁄“ª∂Œ ±º‰∫Û√ª”–’˝»∑¥∏¥ªÚ¡¨Ω”µƒ÷˜ª˙√ª”–∑¥”¶£¨¡¨Ω”≥¢ ‘ ß∞‹°£ 
			{
				return false;
			}
		}	

		//-------------------------Ω” ’ªÿ∏¥,∞—∑µªÿµƒ–≈œ¢¥Ê∑≈µΩm_strNormalText÷–-------------------
		CString strMessage(szBuf);
		ProcessOptions(strMessage);
		if (-1 != strMessage.Find("Login ok"))
		{
			bLoginSuccess = true;
		}
		g_pLog->WriteLog(strMessage,m_strLogFile,LOG_INFO);


		CString strtemp = strMessage.Right(7);
		strtemp.Trim();
		strtemp.Replace("\r","");
		if (-1!=strMessage.Find(">") || -1 != strMessage.Find("<") || -1!=strMessage.Find("Microsoft Corp.") || -1!=strMessage.Find("Last login"))//µ«¬ºÕÍ±œ≥…π¶
		{
			if (-1!=strMessage.Find(">") || -1 != strMessage.Find("<"))
			{
				return true;
			}
		}
		else if (-1 !=strMessage.Find("username:"))//–Ë“™∑¢ÀÕ’À∫≈
		{
			SendMsg(strUser);
		}
		else if (("login:"==strtemp || -1!=strMessage.Find("login name:")) 
			&& (-1==strMessage.Find("Last login:")))//–Ë“™∑¢ÀÕ’À∫≈
		{
			SendMsg(strUser);
		}
		else if (-1 != strMessage.Find("password:")|| -1 != strMessage.Find("Password:"))//–Ë“™∑¢ÀÕ√‹¬Î
		{
			SendMsg(strPassword);
		}
		else if (-1 != strMessage.Find("incorrect"))//µ«¬º ß∞‹
		{
			return false;
		}
		else if (-1 != strMessage.Find("Domain:"))
		{
			SendMsg("");//∑¢ÀÕªÿ≥µ
		}
	}
	return false;
}

bool CTelnet::Logout()
{
	m_bExit = true;
	if (m_hSocket != INVALID_SOCKET)
	{
		send(m_hSocket,"LGO:;",(int)strlen("LGO:;"),0);
		CString strLog;
		strLog.Format("[%s][CTelnet::Logout] µ«≥ˆOMMB\n",m_strThreadName);
		g_pLog->WriteLog(strLog,m_strLogFile,LOG_INFO);

		closesocket(m_hSocket);
		m_hSocket = INVALID_SOCKET;
		return true;
	}
	return false;
}

bool CTelnet::MMLLogout(CString strName,CString strUser)
{
	CString strRecv("");
	CString strLog;
	CString strUnReg;
	CString strLogOut;

	if (m_hSocket != INVALID_SOCKET)
	{
		//◊¢œ˙Õ¯‘™
		strUnReg.Format("UNREG NE:NAME=\"%s\";",strName);

		int nRet = Send(strUnReg,strRecv,CHECK_MMLUNREG);
		if (-1 == strRecv.Find("RETCODE = 0"))
		{
			strLog.Format("[%s][CTelnet::MMLLogout] ◊¢œ˙Õ¯‘™ ß∞‹ Name:[%s]\n",m_strThreadName,strName);
			g_pLog->WriteLog(strLog,m_strLogFile,LOG_INFO);
			return false;
		}

		//µ«≥ˆM2000
		strRecv = "";
		strLogOut.Format("LGO:OP=\"%s\";",strUser);
		nRet = Send(strLogOut,strRecv,CHECK_LOGOUT);
		if(-1 == strRecv.Find("RETCODE = 0"))
		{
			strLog.Format("[%s][CTelnet::MMLLogout] µ«≥ˆM2000 ß∞‹ %s\n",m_strThreadName,strLogOut);
			g_pLog->WriteLog(strLog,m_strLogFile,LOG_INFO);
			return false;
		}

		strLog.Format("[%s][CTelnet::MMLLogout] µ«≥ˆM2000\n",m_strThreadName);
		g_pLog->WriteLog(strLog,m_strLogFile,LOG_INFO);
		closesocket(m_hSocket);
		m_hSocket = INVALID_SOCKET;
		return true;
	}
	return false;
}

CString CTelnet::ProcessOptions(CString& strmsg)
{
	int ndx;
	int ldx;
	unsigned char ch;
	BOOL OMMBanDone = FALSE;
	CString strOption;
	CStringList strListOptions;

	CString strtemp = strmsg;
	strmsg.Empty();

	while(!strtemp.IsEmpty() && !OMMBanDone)
	{
		ndx = strtemp.Find(IAC);
		if (-1 != ndx)
		{
			strmsg += strtemp.Left(ndx);
			ch = strtemp.GetAt(ndx + 1);
			switch (ch)
			{
			case DO:
			case DONT:
			case WILL:
			case WONT:
				{
					strOption = strtemp.Mid(ndx, 3);
					strtemp	= strtemp.Mid(ndx + 3);
					strmsg	= strtemp.Left(ndx);
					strListOptions.AddTail(strOption);
				}
				break;
			case IAC:
				{
					strmsg	= strtemp.Left(ndx);
					strtemp	= strtemp.Mid(ndx + 1);
				}
				break;
			case SB:
				{
					strmsg = strtemp.Left(ndx);
					ldx = strtemp.Find(SE);
					strOption = strtemp.Mid(ndx, ldx);
					strListOptions.AddTail(strOption);
					strtemp	= strtemp.Mid(ldx);
				}
				break;
			}
		}
		else
		{
			strmsg = strtemp;
			OMMBanDone = TRUE;
		}
	} 

	//¥∏¥
	strtemp.Empty();
	while (!strListOptions.IsEmpty())
	{
		strOption = strListOptions.RemoveHead();
		strtemp += ArrangeReply(strOption);
	}
	return strtemp;
}

CString CTelnet::ArrangeReply(CString& strOption)
{
	unsigned char Verb;
	unsigned char Option;
	unsigned char Modifier;
	unsigned char ch;
	BOOL bDefined = FALSE;
	CString strResp;

	Verb = strOption.GetAt(1);
	Option = strOption.GetAt(2);

	switch (Option)
	{
	case 1:	// Echo
	case 3: // Suppress Go-Ahead
		{
			bDefined = TRUE;
		}
		break;
	default:
		break;
	}

	strResp += IAC;

	if(TRUE == bDefined)
	{
		switch (Verb)
		{
		case DO:
			{
				ch = WILL;
				strResp += ch;
				strResp += Option;
			}
			break;
		case DONT:
			{
				ch = WONT;
				strResp += ch;
				strResp += Option;
			}
			break;
		case WILL:
			{
				ch = DO;
				strResp += ch;
				strResp += Option;
			}
			break;
		case WONT:
			{
				ch = DONT;
				strResp += ch;
				strResp += Option;
			}
			break;
		case SB:
			{
				Modifier = strOption.GetAt(3);
				if(SEND == Modifier)
				{
					ch = SB;
					strResp += ch;
					strResp += Option;
					strResp += IS;
					strResp += IAC;
					strResp += SE;
				}
			}
			break;
		default:
			break;
		}
	}
	else
	{
		switch (Verb)
		{
		case DO:
			{
				ch = WONT;
				strResp += ch;
				strResp += Option;
			}
			break;
		case DONT:
			{
				ch = WONT;
				strResp += ch;
				strResp += Option;
			}
			break;
		case WILL:
			{
				ch = DONT;
				strResp += ch;
				strResp += Option;
			}
			break;
		case WONT:
			{
				ch = DONT;
				strResp += ch;
				strResp += Option;
			}
			break;
		default:
			break;
		}
	}
	return strResp;
}

bool CTelnet::ConnectServer(CString strIP, int nPort)
{
	CString strLog;
	//¥¥Ω®socket
	m_hSocket = socket(AF_INET,SOCK_STREAM,IPPROTO_IP);

	if (m_hSocket == INVALID_SOCKET)
	{
		g_pLog->WriteLog("socket(AF_INET,SOCK_STREAM,IPPROTO_IP) Error!",m_strLogFile,LOG_ERROR);
		return false;
	}

	//ππ‘Ïµÿ÷∑∫Õ∂Àø⁄
	sockaddr_in addr;
	addr.sin_family = AF_INET;
	addr.sin_port = htons(nPort);
	addr.sin_addr.s_addr = inet_addr(strIP);

	//¡¨Ω”µΩ∑˛ŒÒ∆˜
	int nResult = connect(m_hSocket,(sockaddr*)&addr,sizeof(sockaddr));	
	if(nResult == SOCKET_ERROR)
	{
		strLog.Format("[%s][CTelnet::ConnectServer] Connect [%s:%d] Error\n",m_strThreadName,strIP,nPort);
		g_pLog->WriteLog(strLog,m_strLogFile,LOG_ERROR);
		return false;
	}

	int nNetTimeout =  30*1000;//10√Î£¨
	//…Ë÷√Ω” ’≥¨ ±
	setsockopt(m_hSocket,SOL_SOCKET,SO_RCVTIMEO,(char *)&nNetTimeout,sizeof(int));

	return true;
}

int CTelnet::Writen(const void* pBuf, int nLen)
{
	int nLeft;
	int nWritten;
	const char *ptr = (const char*)pBuf;
	nLeft = nLen;
	while(nLeft > 0)
	{
		nWritten = ::send(m_hSocket, ptr, nLeft, 0);
		if (nWritten <= 0) 
		{
			break;
		}
		nLeft -= nWritten;
		ptr += nWritten;
	}
	return nLen - nLeft;
}

int CTelnet::Readen(void* pBuf, int nLen)
{
	int nLeft;
	int nRead;
	char *ptr = (char*)pBuf;
	nLeft = nLen;
	while(nLeft > 0)
	{
		nRead = recv(m_hSocket, ptr, nLeft, 0);
		if (nRead <= 0)
		{
			//≥¨ ±,÷±Ω”∑µªÿ
			break;
		}
		nLeft -= nRead;
		ptr += nRead;
	}
	return nLen - nLeft;
}

bool CTelnet::ERICLogin(CString strHost,int nPort,CString strAccount,CString strPassword,int nMode)
{
	bool bRet = false;
	try
	{
		//¥¥Ω®SOCK£¨¡¨Ω”∑˛ŒÒ∆˜
		if (!ConnectERICServ(strHost,nPort))
		{
			return false;
		}

		//µ«¬º ß∞‹
		if (!SendERICLoginInfo(strAccount,strPassword,nMode))
		{
			return false;
		}

		bRet = true;
	}
	catch (...)
	{

	}

	return bRet;
}

bool CTelnet::ConnectERICServ(CString strHost,int nPort)
{
	CString strLog;
	//¥¥Ω®socket
	m_hSocket = socket(AF_INET,SOCK_STREAM,IPPROTO_IP);

	if (m_hSocket == INVALID_SOCKET)
	{
		strLog = "[CTelnet::ConnectERICServ] socket(AF_INET,SOCK_STREAM,IPPROTO_IP) Error!\n";
		g_pLog->WriteLog(strLog,m_strLogFile,LOG_ERROR);
		return false;
	}
	g_pLog->WriteLog("[CTelnet::ConnectERICServ] socket(AF_INET,SOCK_STREAM,IPPROTO_IP) ≥…π¶",m_strLogFile,LOG_INFO);
	//ππ‘Ïµÿ÷∑∫Õ∂Àø⁄
	sockaddr_in addr;
	addr.sin_family = AF_INET;
	addr.sin_port = htons(nPort);
	addr.sin_addr.s_addr = inet_addr(strHost);

	//¡¨Ω”µΩ∑˛ŒÒ∆˜
	int nResult = connect(m_hSocket,(sockaddr*)&addr,sizeof(sockaddr));	
	if(nResult == SOCKET_ERROR)
	{
		strLog.Format("[%s][CTelnet::ConnectERICServ] Connect [%s:%d] Error\n",m_strThreadName,strHost,nPort);
		g_pLog->WriteLog(strLog,m_strLogFile,LOG_ERROR);
		return false;
	}
	strLog.Format("[%s][CTelnet::ConnectERICServ] Connect [%s:%d] ≥…π¶\n",m_strThreadName,strHost,nPort);
	g_pLog->WriteLog(strLog,m_strLogFile,LOG_INFO);

	int nNetTimeout =  30*1000;//10√Î£¨
	//…Ë÷√Ω” ’≥¨ ±
	setsockopt(m_hSocket,SOL_SOCKET,SO_RCVTIMEO,(char *)&nNetTimeout,sizeof(int));

	return true;
}

bool CTelnet::SendERICLoginInfo(CString strAccount,CString strPassword,int nMode)
{
	bool bRet = false;
	bool bLoginSuccess = false;

	int nRecvTimes(0);

	while(nRecvTimes < 100)
	{
		nRecvTimes++;

		//-------------------------Ω” ’ªÿ∏¥,∞—∑µªÿµƒ–≈œ¢¥Ê∑≈µΩm_strNormalText÷–-------------------MSG_WAITALL
		DWORD d1 = GetTickCount();
		int nBytes = recv(m_hSocket, (char *)m_bBuf.GetData(), (int)m_bBuf.GetSize(),0);
		DWORD d2 = GetTickCount();

		if (-1 == nBytes)
		{
			if (10060 != WSAGetLastError())//”…”⁄¡¨Ω”∑Ω‘⁄“ª∂Œ ±º‰∫Û√ª”–’˝»∑¥∏¥ªÚ¡¨Ω”µƒ÷˜ª˙√ª”–∑¥”¶£¨¡¨Ω”≥¢ ‘ ß∞‹°£ 
			{
				return false;
			}
		}	

		int ndx = 0;
		//modified by linzc 130718 
		GetLine(m_bBuf, nBytes, ndx);
		//while(TRUE != GetLine(m_bBuf, nBytes, ndx))
		//{
		//	Sleep(1);
		//}
		//if(g_bIsTest)
		//{
		//	m_strLine.Empty();
		//	m_strLine += IAC;
		//	m_strLine += DO;
		//	m_strLine += MAXTEST;
		//}
		ERICProcessOptions();
		m_strLine.Empty();
		m_strResp.Empty();
		OutputDebugString(m_strNormalText);
		//-------------------------Ω” ’ªÿ∏¥,∞—∑µªÿµƒ–≈œ¢¥Ê∑≈µΩm_strNormalText÷–-------------------

		if (-1 != m_strNormalText.Find("Login ok"))
		{
			bLoginSuccess = true;
		}
		g_pLog->WriteLog(m_strNormalText,m_strLogFile,LOG_INFO);

		CString strtemp = m_strNormalText.Right(7);
		strtemp.Trim();
		strtemp.Replace("\r","");
		if (-1!=m_strNormalText.Find(">") || -1 != m_strNormalText.Find("<") || -1!=m_strNormalText.Find("Microsoft Corp.") || -1!=m_strNormalText.Find("Last login"))//µ«¬ºÕÍ±œ≥…π¶
		{
			if(0 == nMode)
			{
				if (-1!=m_strNormalText.Find(">") || -1 != m_strNormalText.Find("<"))
				{
					return true;
				}
			}
			else
			{
				if (bLoginSuccess)
				{
					return true;
				}
				else
				{
					m_nLoginTime++;
				}
			}
		}
		else if (m_nLoginTime >= 3)//≥¢ ‘»˝¥Œlogin ß∞‹
		{
			return false;
		}
		else if (("login:"==strtemp || -1!=m_strNormalText.Find("login name:")) 
			&& (-1==m_strNormalText.Find("Last login:")))//–Ë“™∑¢ÀÕ’À∫≈
		{
			SendMsg(strAccount);
		}
		else if (-1 != m_strNormalText.Find("assword:"))//–Ë“™∑¢ÀÕ√‹¬Î
		{
			SendMsg(strPassword);
			m_nLoginTime++;
		}
		else if (-1 != m_strNormalText.Find("incorrect"))//µ«¬º ß∞‹
		{
			m_nLoginTime++;
		}
		else if (-1 != m_strNormalText.Find("Domain:"))
		{
			SendMsg("");//∑¢ÀÕªÿ≥µ
		}

		//Ω” ’ ±º‰≥¨π˝9s
		if ((d2-d1)/1000>(30/*g_pConfig->nTimeOut*/))
		{
			return false;
		}
	}

	return bRet;
}


bool CTelnet::GetLine(const CByteArray &bytes, int nBytes, int &ndx)
{
	bool bLine = false;

	try
	{
		if (nBytes<=0)
			return true;

		while (false==bLine && ndx<nBytes)
		{
			unsigned char ch = (char)(bytes.GetAt(ndx));

			switch (ch)
			{
			case '\r':// ignore
				{
					m_strLine += "\r\n"; //"CR";
				}
				break;
			case '\n':// end-of-line
				{
				}
				break;
			default:// other....
				{
					m_strLine += ch;
				}
				break;
			} 

			++ndx;

			if (ndx == nBytes)
				bLine = true;
		}
	}
	catch (...)
	{
	}

	return bLine;
}

void CTelnet::ERICProcessOptions()
{
	try
	{
		CString strLog;
		CString strTemp;
		CString strOption;
		unsigned char ch;
		int ndx;
		int ldx;
		BOOL bScanDone = FALSE;

		strTemp = m_strLine;
		strLog.Format("[%s][CTelnet::ERICProcessOptions] m_strLine [%x] \n",m_strThreadName,m_strLine);
		g_pLog->WriteLog(strLog,m_strLogFile,LOG_INFO);

		while(!strTemp.IsEmpty() && TRUE!=bScanDone)
		{
			ndx = strTemp.Find(IAC);
			if (-1 != ndx)
			{
				m_strNormalText += strTemp.Left(ndx);
				ch = strTemp.GetAt(ndx + 1);
				switch (ch)
				{
				case DO:
				case DONT:
				case WILL:
				case WONT:
					{
						strOption = strTemp.Mid(ndx, 3);
						strTemp	= strTemp.Mid(ndx + 3);
						m_strNormalText	= strTemp.Left(ndx);
						m_strListOptions.AddTail(strOption);
						g_pLog->WriteLog("[CTelnet::ERICProcessOptions] WONT",m_strLogFile,LOG_INFO);
					}
					break;
				case IAC:
					{
						m_strNormalText	= strTemp.Left(ndx);
						strTemp	= strTemp.Mid(ndx + 1);
						g_pLog->WriteLog("[CTelnet::ERICProcessOptions] IAC",m_strLogFile,LOG_INFO);
					}
					break;
				case SB:
					{
						m_strNormalText = strTemp.Left(ndx);
						ldx = strTemp.Find(SE);
						strOption = strTemp.Mid(ndx, ldx);
						m_strListOptions.AddTail(strOption);
						strTemp	= strTemp.Mid(ldx);
						g_pLog->WriteLog("[CTelnet::ERICProcessOptions] SB",m_strLogFile,LOG_INFO);
					}
					break;
				}
			}
			else
			{
				m_strNormalText = strTemp;
				bScanDone = TRUE;
			}
		} 

		ERICRespondToOptions();
	}
	catch (...)
	{
	}
}

void CTelnet::ERICRespondToOptions()
{
	try
	{
		CString strOption,strLog;

		while (!m_strListOptions.IsEmpty())
		{
			strOption = m_strListOptions.RemoveHead();
			ERICArrangeReply(strOption);
		}

		strLog.Format("[%s][CTelnet::ERICRespondToOptions] send [%x] \n",m_strThreadName,strOption);
		g_pLog->WriteLog(strLog,m_strLogFile,LOG_INFO);
		//∑¢ÀÕ
		int nSendLen = send(m_hSocket, m_strResp, (int)m_strResp.GetLength(), 0);

		m_strResp.Empty();
	}
	catch (...)
	{
	}
}

void CTelnet::ERICArrangeReply(CString strOption)
{
	CString strLog;
	try
	{
		unsigned char Verb;
		unsigned char Option;
		unsigned char Modifier;
		unsigned char ch;
		BOOL bDefined = FALSE;

		Verb = strOption.GetAt(1);
		Option = strOption.GetAt(2);
		strLog.Format("[%s][CTelnet::ERICArrangeReply] Verb [%02x] ,Verb [%02x] \n",m_strThreadName,Verb,Option);
		g_pLog->WriteLog(strLog,m_strLogFile,LOG_DEBUG);

		switch (Option)
		{
		case 1:	// Echo
		case 3: // Suppress Go-Ahead
			{
				bDefined = TRUE;
			}
			break;
		default:
			break;
		}

		m_strResp += IAC;

		if(TRUE == bDefined)
		{
			switch (Verb)
			{
			case DO:
				{
					ch = WILL;
					m_strResp += ch;
					m_strResp += Option;
				}
				break;
			case DONT:
				{
					ch = WONT;
					m_strResp += ch;
					m_strResp += Option;
				}
				break;
			case WILL:
				{
					ch = DO;
					m_strResp += ch;
					m_strResp += Option;
				}
				break;
			case WONT:
				{
					ch = DONT;
					m_strResp += ch;
					m_strResp += Option;
				}
				break;
			case SB:
				{
					Modifier = strOption.GetAt(3);
					if(SEND == Modifier)
					{
						ch = SB;
						m_strResp += ch;
						m_strResp += Option;
						m_strResp += IS;
						m_strResp += IAC;
						m_strResp += SE;
					}
				}
				break;
			default:
				break;
			}
		}
		else
		{
			switch (Verb)
			{
			case DO:
				{
					ch = WONT;
					m_strResp += ch;
					m_strResp += Option;
				}
				break;
			case DONT:
				{
					ch = WONT;
					m_strResp += ch;
					m_strResp += Option;
				}
				break;
			case WILL:
				{
					ch = DONT;
					m_strResp += ch;
					m_strResp += Option;
				}
				break;
			case WONT:
				{
					ch = DONT;
					m_strResp += ch;
					m_strResp += Option;
				}
				break;
			default:
				break;
			}
		}
	}
	catch (...)
	{
	}
}

CString CTelnet::BufferFilter( char* pRecBuffer )
{
	//g_pLog->WriteLogFormat(m_strLogFile, LOG_INFO, "[CSTelnet::BufferFilter] π˝¬ÀÃÿ ‚◊÷∑˚ø™ º");

	CString strReceive;
	BOOL bStartFlag = false;
	BOOL bEndFlag = false;
	size_t nLen = strlen(pRecBuffer);

	for (size_t n = 0; n < nLen; n++)
	{
		size_t next1 = n + 1; //91
		size_t next2 = n + 2; //50
		size_t next3 = n + 3; //75
		size_t next4 = n + 4; //27

		if (pRecBuffer[n] == '\x08')
		{// ÕÀ∏Ò
			continue;
		}

		// \x1b[2K\x1b[D Ã¯π˝ 3 ∏ˆ◊÷∑˚
		if (next4 < nLen && pRecBuffer[n] == 27 && pRecBuffer[next1] == 91 && pRecBuffer[next4] == 27)
		{
			n = next3;
			continue;
		}

		// \x1b[D\x1b[D Ã¯π˝ 2 ∏ˆ◊÷∑˚
		if (next3 < nLen && pRecBuffer[n] == 27 && pRecBuffer[next1] == 91 && pRecBuffer[next3] == 27)
		{
			n = next2;
			continue;
		}

		// \x1b[D$>D Ã¯π˝ 2 ∏ˆ◊÷∑˚
		if (next3 < nLen && pRecBuffer[n] == 27 && pRecBuffer[next1] == 91 && pRecBuffer[next3] != 27)
		{
			n = next2;
			continue;
		}

		strReceive.AppendChar(pRecBuffer[n]);
	}

	strReceive.Replace("«Î∞¥»Œ“‚º¸ºÃ–¯(Ctrl+C ÷–∂œœ‘ æ). . .", NULL);

	//g_pLog->WriteLogFormat(m_strLogFile, LOG_INFO, "[CSTelnet::BufferFilter] π˝¬ÀÃÿ ‚◊÷∑˚Ω· ¯");
	return strReceive;
}

CString CTelnet::BufferReplace(CString & strData)
{
	CString strReceive(strData);
	//ÃÊªª[2K[D
	strReceive.Replace("[2K[D","");
	//ÃÊªª[D[D
	strReceive.Replace("[D[D","");
	//ÃÊªª[D
	strReceive.Replace("[D","");
	return strReceive;
}